# OBSOLETO - Usar gcp-deploy.yml en su lugar
# Este workflow está deshabilitado, Railway ya no se usa
name: CD - Deploy to Railway (DEPRECATED)

on:
  workflow_dispatch: # Solo ejecución manual

env:
  NODE_VERSION: '18.x'

jobs:
  # Deploy Backend
  deploy-backend:
    name: Deploy Backend to Railway
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name }}
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "service_name=dicri-backend-prod" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" == "staging" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "service_name=dicri-backend-staging" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "service_name=dicri-backend-dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy Backend to Railway
        id: deploy
        working-directory: ./backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Deploying to ${{ steps.env.outputs.environment }}"
          railway up --service ${{ steps.env.outputs.service_name }}
          echo "url=https://${{ steps.env.outputs.service_name }}.railway.app" >> $GITHUB_OUTPUT
      
      - name: Health Check
        run: |
          sleep 30
          curl -f ${{ steps.deploy.outputs.url }}/health || echo "Health check failed"

  # Deploy Frontend
  deploy-frontend:
    name: Deploy Frontend to Railway
    runs-on: ubuntu-latest
    needs: deploy-backend
    environment:
      name: ${{ github.ref_name }}
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "service_name=dicri-frontend-prod" >> $GITHUB_OUTPUT
            echo "api_url=${{ secrets.PROD_API_URL }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" == "staging" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "service_name=dicri-frontend-staging" >> $GITHUB_OUTPUT
            echo "api_url=${{ secrets.STAGING_API_URL }}" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "service_name=dicri-frontend-dev" >> $GITHUB_OUTPUT
            echo "api_url=${{ secrets.DEV_API_URL }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy Frontend to Railway
        id: deploy
        working-directory: ./frontend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          VITE_API_URL: ${{ steps.env.outputs.api_url }}
        run: |
          echo "Deploying to ${{ steps.env.outputs.environment }}"
          railway up --service ${{ steps.env.outputs.service_name }}
          echo "url=https://${{ steps.env.outputs.service_name }}.railway.app" >> $GITHUB_OUTPUT
      
      - name: Health Check
        run: |
          sleep 30
          curl -f ${{ steps.deploy.outputs.url }} || echo "Health check failed"

  # Notificación de deploy exitoso
  notify-success:
    name: Notify Deployment Success
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()
    
    steps:
      - name: Send Success Notification
        run: |
          echo "✅ Deployment to ${{ github.ref_name }} completed successfully!"
          echo "Backend and Frontend services are now live."

  # Notificación de deploy fallido
  notify-failure:
    name: Notify Deployment Failure
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: failure()
    
    steps:
      - name: Send Failure Notification
        run: |
          echo "❌ Deployment to ${{ github.ref_name }} failed!"
          echo "Please check the logs for more details."
